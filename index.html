<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<head>
<title>Experiments with HTTP/2 server
</title>
<link type='text/css' href='style.css' rel='stylesheet'>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width">
   <script src="jquery.min.js"></script>
<script src="toc.min.js"></script>
<script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       tex2jax: {
         inlineMath: [['$','$']],
         processEscapes: true
       }
     });
   </script>
   <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
   </script>
   
</head>
<body>
<div id="content-container">
<div id="toc">
<div id="page-toc">
</div>
<div id="toc-footer"><ul><li><a href="https://github.com/melisgl/mgl-pax">[generated by MGL-PAX]</a></li></ul></div>
</div>
<div id="content">
<p><a id="x-28TLS-SERVER-3A-40INDEX-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER:@INDEX%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION" title="Generic server interface">&#8594;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8634;</a></span></span></p>
<h1><a href="index.html">Experiments with HTTP/2 server</a></h1>
<h2>Table of Contents</h2>
<ul>
<li><a href="#TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION" title="Generic server interface">1 Generic server interface</a></li>
<li><a href="#TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION" title="Implementations">2 Implementations</a></li>
<li><a href="#TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION" title="Work with octets">3 Work with octets</a></li>
<li><a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">4 HTTP/2 protocol.</a>

<ul>
<li><a href="#TLS-SERVER%2FMINI-HTTP2:@PREBUILT-FRAMES%20MGL-PAX:SECTION" title="Prebuild frames">4.1 Prebuild frames</a></li>
<li><a href="#TLS-SERVER%2FMINI-HTTP2:@HEADER-EXTRACTORS%20MGL-PAX:SECTION" title="Header parsing">4.2 Header parsing</a></li>
<li><a href="#TLS-SERVER%2FMINI-HTTP2:@ERRORS%20MGL-PAX:SECTION" title="Error conditions">4.3 Error conditions</a></li>
</ul></li>
<li><a href="#TLS-SERVER%2FMINI-HTTP2:@TLS%20MGL-PAX:SECTION" title="`TLS` with CL+SSL">5 <code>TLS</code> with CL+SSL</a></li>
<li><a href="#TLS-SERVER%2FSYNCHRONOUS:@SYNCHRONOUS%20MGL-PAX:SECTION" title="Synchronous implementations">6 Synchronous implementations</a></li>
<li><a href="#TLS-SERVER%2FMINI-HTTP2:@USE-HTTP2-LIB%20MGL-PAX:SECTION" title="Server built using HTTP2 package.">7 Server built using HTTP2 package.</a></li>
<li><a href="#TLS-SERVER%2FASYNC:@ASYNC%20MGL-PAX:SECTION" title="CL-ASYNC based implementation (asynchronous)">8 CL-ASYNC based implementation (asynchronous)</a></li>
<li><a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Asynchronous `TLS` server">9 Asynchronous <code>TLS</code> server</a>

<ul>
<li><a href="#TLS-SERVER%2FASYNC%2FTLS:@COMMUNICATION-SETUP%20MGL-PAX:SECTION" title="Communication setup">9.1 Communication setup</a></li>
<li><a href="#TLS-SERVER%2FASYNC%2FTLS:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Communication setup">9.2 Communication setup</a></li>
</ul></li>
<li><a href="#TLS-SERVER%2FUTILS:@MGL-EXTENSIONS%20MGL-PAX:SECTION" title="New locatives">10 New locatives</a></li>
<li><a href="#TLS-SERVER:@PACKAGES%20MGL-PAX:SECTION" title="Packages">11 Packages</a></li>
</ul>
<h6>[in package TLS-SERVER]</h6>
<p>I wanted to play with different options for HTTP/2 server implementations. While
I have a more correct implementation of HTTP/2, I wanted something simple to
test different client handling options, as well as speed limits and impact of
different choices.</p>
<p>So this repository implements:</p>
<ul>
<li><p>very simplified (and indeed incorrect in more than few ways) server side of HTTP/2</p></li>
<li><p>protocol, and based of that several versions of TCP server that accept and</p></li>
<li><p>handle the request.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3A-40SERVER-ACTIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="index.html" title="Experiments with HTTP/2 server">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION" title="Implementations">&#8594;</a> <a href="#TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION" title="Generic server interface">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION">1 Generic server interface</a></h2>
<p>The functions below implement server creation on an abstract level. Individual
server types implement appropriate methods to ensure desired behaviour.</p>
<p><a id="x-28TLS-SERVER-3ACREATE-SERVER-20FUNCTION-29"></a>
<a id="TLS-SERVER:CREATE-SERVER%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER:CREATE-SERVER%20FUNCTION" >CREATE-SERVER</a></span></span> <span class="locative-args">PORT TLS DISPATCH-METHOD &amp;KEY (HOST &quot;127.0.0.1&quot;) (ANNOUNCE-URL-CALLBACK (<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_cons_1.htm" title="CONSTANTLY (MGL-PAX:CLHS FUNCTION)"><code>CONSTANTLY</code></a> <code>NIL</code>))</span></span></p>

<p>Create a server on <code>HOST</code> and <code>PORT</code> that handles connections (possibly with <code>TLS</code>) using
<code>DISPATCH-METHOD</code>.</p>

<p><code>ANNOUNCE-URL-CALLBACK</code> is called when server is set up on the TCP level and
receives one parameter, <code>URL</code> that server listens on. The idea is to be able to connect
to server when <code>PORT</code> is 0, that is, random port.</p>

<p>Establishes restart <a href="#TLS-SERVER:KILL-SERVER%20RESTART" title="TLS-SERVER:KILL-SERVER RESTART"><code>KILL-SERVER</code></a> to close the TCP connection and return.</p>

<p>Calls <a href="#TLS-SERVER:DO-NEW-CONNECTION%20GENERIC-FUNCTION" title="TLS-SERVER:DO-NEW-CONNECTION GENERIC-FUNCTION"><code>DO-NEW-CONNECTION</code></a> to actually handle the connections after the callback
returns This function also receives the listening socket ad <code>TLS</code> and
<code>DISPATCH-METHOD</code> as parameters.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20GENERIC-FUNCTION-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20GENERIC-FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20GENERIC-FUNCTION" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS DISPATCH-METHOD</span></span></p>

<p>This method is implemented for the separate connection types. It waits on
new (possibly tls) connection to the <code>LISTENING-SOCKET</code> and start handling it
using <code>DISPATCH-METHOD</code>.</p>

<p>See <a href="#TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION" title="Implementations">Implementations</a> for available <code>DISPATCH-METHOD</code>.</p>

<p><code>TLS</code> is either <code>NIL</code> or <code>:TLS</code>. Note that when using HTTP/2 without <code>TLS</code>, most clients have to be instructed to
use tls - e.g., --http2-prior-knowledge for curl.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3AKILL-SERVER-20RESTART-29"></a>
<a id="TLS-SERVER:KILL-SERVER%20RESTART"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[restart]</span> <span class="reference-object"><a href="#TLS-SERVER:KILL-SERVER%20RESTART" >KILL-SERVER</a></span></span> <span class="locative-args">&amp;OPTIONAL VALUE</span></span></p>

<p>Restart established in <a href="#TLS-SERVER:CREATE-SERVER%20FUNCTION" title="TLS-SERVER:CREATE-SERVER FUNCTION"><code>CREATE-SERVER</code></a> that can be invoked to terminate the server
properly and return <code>VALUE</code>.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3AKILL-SERVER-20FUNCTION-29"></a>
<a id="TLS-SERVER:KILL-SERVER%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER:KILL-SERVER%20FUNCTION" >KILL-SERVER</a></span></span> <span class="locative-args">&amp;OPTIONAL RES</span></span></p>

<p>Kill server by invoking <a href="#TLS-SERVER:KILL-SERVER%20RESTART" title="TLS-SERVER:KILL-SERVER RESTART"><code>KILL-SERVER</code></a> restart, if it exists.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3AKILL-PARENT-20RESTART-29"></a>
<a id="TLS-SERVER:KILL-PARENT%20RESTART"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[restart]</span> <span class="reference-object"><a href="#TLS-SERVER:KILL-PARENT%20RESTART" >KILL-PARENT</a></span></span> <span class="locative-args">&amp;OPTIONAL VALUE</span></span></p>

<p>Restart established in <a href="#TLS-SERVER:CREATE-SERVER%20FUNCTION" title="TLS-SERVER:CREATE-SERVER FUNCTION"><code>CREATE-SERVER</code></a> that TODO</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3AGO-AWAY-20RESTART-29"></a>
<a id="TLS-SERVER:GO-AWAY%20RESTART"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[restart]</span> <span class="reference-object"><a href="#TLS-SERVER:GO-AWAY%20RESTART" >GO-AWAY</a></span></span> <span class="locative-args">&amp;OPTIONAL VALUE</span></span></p>

<p>Handler to be invoked to close HTTP connection from our side.</p>

<p>It is established either in <a href="#TLS-SERVER%2FSYNCHRONOUS:DO-CONNECTION%20FUNCTION" title="TLS-SERVER/SYNCHRONOUS:DO-CONNECTION FUNCTION"><code>TLS-SERVER/SYNCHRONOUS:DO-CONNECTION</code></a>.</p>

<p>TODO: Should we have it in async-cffi loop as well?</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ACALLBACK-ON-SERVER-20FUNCTION-29"></a>
<a id="TLS-SERVER:CALLBACK-ON-SERVER%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER:CALLBACK-ON-SERVER%20FUNCTION" >CALLBACK-ON-SERVER</a></span></span> <span class="locative-args">FN &amp;KEY (THREAD-NAME &quot;Test client for a server&quot;)</span></span></p>

<p>Return a function that takes one parameter, <code>URL</code>, as a parameter and calls <code>FN</code> on
it in a separate thread. Then it kills the server by invoking <a href="#TLS-SERVER:KILL-SERVER%20RESTART" title="TLS-SERVER:KILL-SERVER RESTART"><code>KILL-SERVER</code></a> restart.</p>

<p>This is to be used as callback on an open server for testing it.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3AURL-FROM-SOCKET-20FUNCTION-29"></a>
<a id="TLS-SERVER:URL-FROM-SOCKET%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER:URL-FROM-SOCKET%20FUNCTION" >URL-FROM-SOCKET</a></span></span> <span class="locative-args">SOCKET HOST TLS</span></span></p>

<p>Return <code>URL</code> that combines <code>HOST</code> with the port of the <code>SOCKET</code>.</p>

<p>This is to be used as callback fn on an open server for testing it.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3A-2ABUFFER-2A-20VARIABLE-29"></a>
<a id="TLS-SERVER:*BUFFER*%20VARIABLE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER:*BUFFER*%20VARIABLE" >*BUFFER*</a></span></span> <span class="locative-args">NIL</span></span></p>

<p>Preallocated buffer for reading from stream. This is initialized for each
connection depending on the dispatch method.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3A-40IMPLEMENTATIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION" title="Generic server interface">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION" title="Work with octets">&#8594;</a> <a href="#TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION" title="Implementations">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION">2 Implementations</a></h2>
<p>Following implementations are defined:</p>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20T-20-28EQL-20-3ANONE-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:NONE</code>))</span></span></p>

<p>Handle the connection while doing nothing else.</p>

<p>Serve just one cliet at time: on connection, read the requests and handle them as they
arrive. When the client sends go-away frame, close connection and be ready
to serve another client.</p>

<p>Obviously, there is little overhead and this version is actually pretty fast,
especially with request pilelining.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20T-20-28EQL-20-3ATHREAD-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:THREAD%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:THREAD%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:THREAD</code>))</span></span></p>

<p>Handle the connection in a new thread.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20T-20-28EQL-20-3ANONE-2FHTTP2-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%2FHTTP2%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%2FHTTP2%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:NONE/HTTP2</code>))</span></span></p>

<p>Handle the connection while doing nothing else using HTTP2 asdf library for actual work. Otherwise it is same as the <code>:NONE</code> method (i.e., serving a single client)</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20-28EQL-20NIL-29-20-28EQL-20-3AASYNC-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20NIL%29%20%28EQL%20:ASYNC%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20NIL%29%20%28EQL%20:ASYNC%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">SOCKET (TLS (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>NIL</code>)) (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:ASYNC</code>))</span></span></p>

<p>Handle new connections using cl-async event loop.</p>

<p>Pros: This version can be run in one thread and process many clients.</p>

<p>Cons: requires a specific C library, and the implementation as-is depends on
SBCL internal function - we re-use the file descriptor of socket created by
usocket package, as otherwise access to the port of server is complicated.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20-28EQL-20T-29-20-28EQL-20-3AASYNC-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20T%29%20%28EQL%20:ASYNC%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20T%29%20%28EQL%20:ASYNC%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">SOCKET (TLS (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>T</code>)) (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:ASYNC</code>))</span></span></p>

<p>Handle new connections using cl-async event loop.</p>

<p>Pros: This version can be run in one thread and process many clients.</p>

<p>Cons: requires a specific C library, and the implementation as-is depends on
SBCL internal function - we re-use the file descriptor of socket created by
usocket package, as otherwise access to the port of server is complicated.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20-28EQL-20-3ANONBLOCK-29-20-28EQL-20-3AASYNC-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20:NONBLOCK%29%20%28EQL%20:ASYNC%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20:NONBLOCK%29%20%28EQL%20:ASYNC%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">SOCKET (TLS (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:NONBLOCK</code>)) (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:ASYNC</code>))</span></span></p>

<p>Handle new connections using cl-async event loop.</p>

<p>Pros: This version can be run in one thread and process many clients.</p>

<p>Cons: requires a specific C library, and the implementation as-is depends on
SBCL internal function - we re-use the file descriptor of socket created by
usocket package, as otherwise access to the port of server is complicated.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20-28EQL-20-3ATLS-29-20-28EQL-20-3AASYNC-CUSTOM-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20:TLS%29%20%28EQL%20:ASYNC-CUSTOM%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20:TLS%29%20%28EQL%20:ASYNC-CUSTOM%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">SOCKET (TLS (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:TLS</code>)) (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:ASYNC-CUSTOM</code>))</span></span></p>

<p>Handle new connections using TLS-SERVE above.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FUTILS-3A-40OCTETS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER:@IMPLEMENTATIONS%20MGL-PAX:SECTION" title="Implementations">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">&#8594;</a> <a href="#TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION" title="Work with octets">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION">3 Work with octets</a></h2>
<h6>[in package TLS-SERVER/UTILS]</h6>
<p>Simplify work with octet vectors</p>
<p><a id="x-28TLS-SERVER-2FUTILS-3AOCTET-VECTOR-20TYPE-29"></a>
<a id="TLS-SERVER%2FUTILS:OCTET-VECTOR%20TYPE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[type]</span> <span class="reference-object"><a href="#TLS-SERVER%2FUTILS:OCTET-VECTOR%20TYPE" >OCTET-VECTOR</a></span></span></span></p>

<p>Simple (i.e., not adjustable and w/o fill pointer) one-dimensional array of
octets</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FUTILS-3AOCTETIZE-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FUTILS:OCTETIZE%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FUTILS:OCTETIZE%20FUNCTION" >OCTETIZE</a></span></span> <span class="locative-args">ARRAY</span></span></p>

<p>Make a simple one-dimensional array of octets with same content as <code>ARRAY</code>.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FUTILS-3AFULLY-READ-ARRAY-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FUTILS:FULLY-READ-ARRAY%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FUTILS:FULLY-READ-ARRAY%20FUNCTION" >FULLY-READ-ARRAY</a></span></span> <span class="locative-args">STREAM VECTOR TO-READ</span></span></p>

<p>Read <code>TO-READ</code> octets to the octet <code>VECTOR</code>.</p>

<p>Lisp standard says that read-sequence returns less than required bytes only on
EOF, and we rely on that; if this happens, invoke <a href="#TLS-SERVER:GO-AWAY%20RESTART" title="TLS-SERVER:GO-AWAY RESTART"><code>GO-AWAY</code></a> restart.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-40HTTP2-PROTOCOL-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION" title="Work with octets">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@PREBUILT-FRAMES%20MGL-PAX:SECTION" title="Prebuild frames">&#8594;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION">4 HTTP/2 protocol.</a></h2>
<h6>[in package TLS-SERVER/MINI-HTTP2]</h6>
<p>Simplified - and incorrect in many corner cases - HTTP/2 protocol implemented
here is is as follows. This should be sufficient to respond to a browser, curl
or h2load.</p>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2BCLIENT-PREFACE-START-2B-20VARIABLE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:+CLIENT-PREFACE-START+%20VARIABLE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:+CLIENT-PREFACE-START+%20VARIABLE" >+CLIENT-PREFACE-START+</a></span></span> <span class="locative-args">#(80 82 73 32 42 32 72 84 84 80 47 50 46 48 13 10 13 10 83 77 13 10 13 10)</span></span></p>

<p>Clients send 24 octets of <code>+CLIENT-PREFACE-START+</code>, which in hex
notation is this. That is, the connection preface starts with the string &quot;PRI *
 HTTP/2.0\r\n\r\nSM\r\n\r\n&quot;.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2BCLIENT-PREFACE-LENGTH-2B-20MGL-PAX-3ACONSTANT-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:+CLIENT-PREFACE-LENGTH+%20MGL-PAX:CONSTANT"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[constant]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:+CLIENT-PREFACE-LENGTH+%20MGL-PAX:CONSTANT" >+CLIENT-PREFACE-LENGTH+</a></span></span> <span class="locative-args">24</span></span></p>

<p>Length of the client preface.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AREAD-CLIENT-PREFACE-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:READ-CLIENT-PREFACE%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:READ-CLIENT-PREFACE%20FUNCTION" >READ-CLIENT-PREFACE</a></span></span> <span class="locative-args">STREAM</span></span></p>

<p>Read the client preface from a stream and verify it.</p>

<p>Signal <a href="#TLS-SERVER%2FMINI-HTTP2:CLIENT-PREFACE-MISMATCH%20CONDITION" title="TLS-SERVER/MINI-HTTP2:CLIENT-PREFACE-MISMATCH CONDITION"><code>CLIENT-PREFACE-MISMATCH</code></a> on mismatch.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2BGOAWAY-FRAME-TYPE-2B-20MGL-PAX-3ACONSTANT-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:+GOAWAY-FRAME-TYPE+%20MGL-PAX:CONSTANT"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[constant]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:+GOAWAY-FRAME-TYPE+%20MGL-PAX:CONSTANT" >+GOAWAY-FRAME-TYPE+</a></span></span> <span class="locative-args">7</span></span></p>

<p>When client is done (or after an error) it sends goaway frame, and both client
and server terminate the connection socket. This is kind of courtesy, and any
side should be ready for the other side terminating connection without goaway
frame.</p>

<p>Server can send goaway frame as well, but our servers do not.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AMAYBE-ADD-TLS-20GENERIC-FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:MAYBE-ADD-TLS%20GENERIC-FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[generic-function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:MAYBE-ADD-TLS%20GENERIC-FUNCTION" >MAYBE-ADD-TLS</a></span></span> <span class="locative-args">SOCKET TLS</span></span></p>

<p>Return either plain (if tls is nil) or <code>TLS</code> (if :tls) Lisp stream
 build upon <code>SOCKET</code> stream.</p>

<p>This is used by implementation that use usocket sockets.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3ABUFFER-WITH-CHANGED-STREAM-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:BUFFER-WITH-CHANGED-STREAM%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:BUFFER-WITH-CHANGED-STREAM%20FUNCTION" >BUFFER-WITH-CHANGED-STREAM</a></span></span> <span class="locative-args">BUF STREAM-ID</span></span></p>

<p>Change stream id of a frame in <code>BUF</code> to <code>STREAM-ID</code>.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3ASEND-RESPONSE-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:SEND-RESPONSE%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:SEND-RESPONSE%20FUNCTION" >SEND-RESPONSE</a></span></span> <span class="locative-args">STREAM STREAM-ID</span></span></p>

<p>Write response to the request with <code>STREAM-ID</code> to Common Lisp output <code>STREAM</code>.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-40PREBUILT-FRAMES-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:@PREBUILT-FRAMES%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">&#8592;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">&#8593;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HEADER-EXTRACTORS%20MGL-PAX:SECTION" title="Header parsing">&#8594;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@PREBUILT-FRAMES%20MGL-PAX:SECTION" title="Prebuild frames">&#8634;</a></span></span></p>
<h3><a href="#TLS-SERVER%2FMINI-HTTP2:@PREBUILT-FRAMES%20MGL-PAX:SECTION">4.1 Prebuild frames</a></h3>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2ASETTINGS-FRAME-2A-20VARIABLE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:*SETTINGS-FRAME*%20VARIABLE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:*SETTINGS-FRAME*%20VARIABLE" >*SETTINGS-FRAME*</a></span></span> <span class="locative-args">#(0 0 0 4 0 0 0 0 0)</span></span></p>

<p>After client preface, both client and server send their settings frame
(<code>*SETTINGS-FRAME*</code>). The frame here is empty settings frame.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2AACK-FRAME-2A-20VARIABLE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:*ACK-FRAME*%20VARIABLE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:*ACK-FRAME*%20VARIABLE" >*ACK-FRAME*</a></span></span> <span class="locative-args">#(0 0 0 4 1 0 0 0 0)</span></span></p>

<p>Settings frame should be acknowledged by sending <code>*ACK-FRAME*</code> (type+flag)</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2ADATA-FRAME-2A-20VARIABLE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:*DATA-FRAME*%20VARIABLE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:*DATA-FRAME*%20VARIABLE" >*DATA-FRAME*</a></span></span> <span class="locative-args">#(0 0 12 0 1 0 0 0 1 72 101 108 108 111 32 87 111 114 108 100 10)</span></span></p>

<p>Server replies to header frame with header and data frames with same stream
ID. The data frame here is a data frame with zero stream ID (to be patched
before sending) and payload short ASCII text from <em>result-text</em>.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2AHEADER-FRAME-2A-20VARIABLE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:*HEADER-FRAME*%20VARIABLE"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:*HEADER-FRAME*%20VARIABLE" >*HEADER-FRAME*</a></span></span> <span class="locative-args">#(0 0 11 1 4 0 0 0 1 136 15 16 135 73 124 165 137 211 77 31)</span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-40HEADER-EXTRACTORS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:@HEADER-EXTRACTORS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FMINI-HTTP2:@PREBUILT-FRAMES%20MGL-PAX:SECTION" title="Prebuild frames">&#8592;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">&#8593;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@ERRORS%20MGL-PAX:SECTION" title="Error conditions">&#8594;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HEADER-EXTRACTORS%20MGL-PAX:SECTION" title="Header parsing">&#8634;</a></span></span></p>
<h3><a href="#TLS-SERVER%2FMINI-HTTP2:@HEADER-EXTRACTORS%20MGL-PAX:SECTION">4.2 Header parsing</a></h3>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3ASTREAM-ID-20TYPE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:STREAM-ID%20TYPE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[type]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:STREAM-ID%20TYPE" >STREAM-ID</a></span></span></span></p>

<p>Client sends HTTP2 requests as a headers (and possibly data) frame, with last
packet having END-OF-HEADERS flag
particular stream. Each stream is a 23 bit integer.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AFRAME-SIZE-20TYPE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:FRAME-SIZE%20TYPE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[type]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:FRAME-SIZE%20TYPE" >FRAME-SIZE</a></span></span></span></p>

<p>Frame size parameter can be 32 bits long; however, values above 2^14 are an error.</p></li>
</ul>
<p>Following function extract appropriate parameter from the header.</p>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AGET-STREAM-ID-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:GET-STREAM-ID%20FUNCTION"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:GET-STREAM-ID%20FUNCTION" >GET-STREAM-ID</a></span></span> <span class="locative-args">HEADER</span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AGET-FRAME-TYPE-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:GET-FRAME-TYPE%20FUNCTION"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:GET-FRAME-TYPE%20FUNCTION" >GET-FRAME-TYPE</a></span></span> <span class="locative-args">HEADER</span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AGET-FRAME-FLAGS-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:GET-FRAME-FLAGS%20FUNCTION"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:GET-FRAME-FLAGS%20FUNCTION" >GET-FRAME-FLAGS</a></span></span> <span class="locative-args">HEADER</span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AGET-FRAME-SIZE-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:GET-FRAME-SIZE%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:GET-FRAME-SIZE%20FUNCTION" >GET-FRAME-SIZE</a></span></span> <span class="locative-args">HEADER</span></span></p>

<p>Get frame size of a frame from frame header.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AGET-STREAM-ID-IF-ENDS-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:GET-STREAM-ID-IF-ENDS%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:GET-STREAM-ID-IF-ENDS%20FUNCTION" >GET-STREAM-ID-IF-ENDS</a></span></span> <span class="locative-args">HEADER</span></span></p>

<p>Stream id when header closes the stream on client side. Nil otherwise.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-40ERRORS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:@ERRORS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FMINI-HTTP2:@HEADER-EXTRACTORS%20MGL-PAX:SECTION" title="Header parsing">&#8592;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">&#8593;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@TLS%20MGL-PAX:SECTION" title="`TLS` with CL+SSL">&#8594;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@ERRORS%20MGL-PAX:SECTION" title="Error conditions">&#8634;</a></span></span></p>
<h3><a href="#TLS-SERVER%2FMINI-HTTP2:@ERRORS%20MGL-PAX:SECTION">4.3 Error conditions</a></h3>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3ACLIENT-PREFACE-MISMATCH-20CONDITION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:CLIENT-PREFACE-MISMATCH%20CONDITION"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[condition]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:CLIENT-PREFACE-MISMATCH%20CONDITION" >CLIENT-PREFACE-MISMATCH</a></span></span> <span class="locative-args"><a href="http://www.lispworks.com/documentation/HyperSpec/Body/e_error.htm" title="ERROR (MGL-PAX:CLHS CONDITION)">ERROR</a></span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-40TLS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:@TLS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FMINI-HTTP2:@ERRORS%20MGL-PAX:SECTION" title="Error conditions">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FSYNCHRONOUS:@SYNCHRONOUS%20MGL-PAX:SECTION" title="Synchronous implementations">&#8594;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@TLS%20MGL-PAX:SECTION" title="`TLS` with CL+SSL">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FMINI-HTTP2:@TLS%20MGL-PAX:SECTION">5 <code>TLS</code> with CL+SSL</a></h2>
<h6>[in package TLS-SERVER/MINI-HTTP2]</h6>
<p>HTTP/2 in most cases needs TLS as an underlying layer.</p>
<p>We use <a href="#TLS-SERVER%2FMINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT%20FUNCTION" title="TLS-SERVER/MINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT FUNCTION"><code>MAKE-HTTP2-TLS-CONTEXT</code></a> to prepare a context that is later stored in
<a href="#TLS-SERVER%2FMINI-HTTP2:*HTTP2-TLS-CONTEXT*%20VARIABLE" title="TLS-SERVER/MINI-HTTP2:*HTTP2-TLS-CONTEXT* VARIABLE"><code>*HTTP2-TLS-CONTEXT*</code></a> to have (some) parameters set up properly</p>
<p>Servers using usocket and Lisp streams use <a href="#TLS-SERVER%2FMINI-HTTP2:WRAP-TO-TLS%20FUNCTION" title="TLS-SERVER/MINI-HTTP2:WRAP-TO-TLS FUNCTION"><code>WRAP-TO-TLS</code></a> to establish <code>TLS</code>.</p>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AMAKE-HTTP2-TLS-CONTEXT-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT%20FUNCTION" >MAKE-HTTP2-TLS-CONTEXT</a></span></span></span></p>

<p>make a TLS context suitable for http2.</p>

<p>practically, it means:</p>

<ul>
<li><p>ALPN callback that selects h2 if present,</p></li>
<li><p>do not request client certificates</p></li>
<li><p>do not allow ssl compression adn renegotiation.
we should also limit allowed ciphers, but we do not.</p></li>
</ul></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3AWRAP-TO-TLS-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:WRAP-TO-TLS%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:WRAP-TO-TLS%20FUNCTION" >WRAP-TO-TLS</a></span></span> <span class="locative-args">RAW-STREAM</span></span></p>

<p>Return a binary stream representing <code>TLS</code> server connection over <code>RAW-STREAM</code>.</p>

<p>Use <code>TLS</code> KEY and CERT for server identity, and <a href="#TLS-SERVER%2FMINI-HTTP2:*HTTP2-TLS-CONTEXT*%20VARIABLE" title="TLS-SERVER/MINI-HTTP2:*HTTP2-TLS-CONTEXT* VARIABLE"><code>*HTTP2-TLS-CONTEXT*</code></a> for the contex.</p>

<p>This is a simple wrapper over CL+SSL.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-2AHTTP2-TLS-CONTEXT-2A-20VARIABLE-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:*HTTP2-TLS-CONTEXT*%20VARIABLE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[variable]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:*HTTP2-TLS-CONTEXT*%20VARIABLE" >*HTTP2-TLS-CONTEXT*</a></span></span> <span class="locative-args">#.(SB-SYS:INT-SAP #X7FC5C012FBF0)</span></span></p>

<p><code>TLS</code> context to use for our servers.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3ASELECT-H2-CALLBACK-20TLS-SERVER-2FUTILS-3ACALLBACK-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:SELECT-H2-CALLBACK%20TLS-SERVER%2FUTILS:CALLBACK"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[callback]</span> <span class="reference-object"><a href="#TLS-SERVER%2FMINI-HTTP2:SELECT-H2-CALLBACK%20TLS-SERVER%2FUTILS:CALLBACK" >SELECT-H2-CALLBACK</a></span></span> <span class="locative-args">SSL OUT OUTLEN IN INLEN ARGS</span></span></p>

<p>To be used as a callback in ssl-ctx-set-alpn-select-cb.</p>

<p>Chooses h2 as ALPN if it was offered, otherwise the first offered.</p>

<p>This is basically reimplemented <code>SSL</code>_select_next_proto, but easier than to
use that one in ffi world.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FSYNCHRONOUS-3A-40SYNCHRONOUS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FSYNCHRONOUS:@SYNCHRONOUS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FMINI-HTTP2:@TLS%20MGL-PAX:SECTION" title="`TLS` with CL+SSL">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@USE-HTTP2-LIB%20MGL-PAX:SECTION" title="Server built using HTTP2 package.">&#8594;</a> <a href="#TLS-SERVER%2FSYNCHRONOUS:@SYNCHRONOUS%20MGL-PAX:SECTION" title="Synchronous implementations">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FSYNCHRONOUS:@SYNCHRONOUS%20MGL-PAX:SECTION">6 Synchronous implementations</a></h2>
<h6>[in package TLS-SERVER/SYNCHRONOUS]</h6>
<p>Simplest implementation is a single thread that reads and handles the
requests. Once the request from a client is received, this client is listened to
until finished, and then can next client connect.</p>
<p>Obviously not ideal, but simple.</p>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20T-20-28EQL-20-3ANONE-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:NONE</code>))</span></span></p>

<p>Handle the connection while doing nothing else.</p>

<p>Serve just one cliet at time: on connection, read the requests and handle them as they
arrive. When the client sends go-away frame, close connection and be ready
to serve another client.</p>

<p>Obviously, there is little overhead and this version is actually pretty fast,
especially with request pilelining.</p></li>
</ul>
<p>Another implementation is a thread for the listener, and new thread for each
client. Now this is used by Hunchentoot and other non-lisp implementations, and
works quite well under many conditions.</p>
<p>This version has supposedly disadvantage when there are too many
clients/threads (RAM for threads needed, etc).</p>
<p>The speed for single client is comparable to the single-client version.</p>
<p>Also, this version (as well as the single client one) can be ported to most CL
implementations, as it uses standard libraries - bordeaux-threads, cl+ssl and
usocket.</p>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20T-20-28EQL-20-3ATHREAD-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:THREAD%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:THREAD%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:THREAD</code>))</span></span></p>

<p>Handle the connection in a new thread.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FSYNCHRONOUS-3ADO-CONNECTION-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FSYNCHRONOUS:DO-CONNECTION%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FSYNCHRONOUS:DO-CONNECTION%20FUNCTION" >DO-CONNECTION</a></span></span> <span class="locative-args">STREAM</span></span></p>

<p>Process a HTTP2 connection naively: handle preface, and read frames till there
  is end of stream; write static response in that case.</p>

<p>Terminate if either SSL error occurs, or <a href="#TLS-SERVER:GO-AWAY%20RESTART" title="TLS-SERVER:GO-AWAY RESTART"><code>GO-AWAY</code></a> restart is invoked.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3AGO-AWAY-20RESTART-29"></a>
<a id="TLS-SERVER:GO-AWAY%20RESTART"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[restart]</span> <span class="reference-object"><a href="#TLS-SERVER:GO-AWAY%20RESTART" >GO-AWAY</a></span></span> <span class="locative-args">&amp;OPTIONAL VALUE</span></span></p>

<p>Handler to be invoked to close HTTP connection from our side.</p>

<p>It is established either in <a href="#TLS-SERVER%2FSYNCHRONOUS:DO-CONNECTION%20FUNCTION" title="TLS-SERVER/SYNCHRONOUS:DO-CONNECTION FUNCTION"><code>TLS-SERVER/SYNCHRONOUS:DO-CONNECTION</code></a>.</p>

<p>TODO: Should we have it in async-cffi loop as well?</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FMINI-HTTP2-3A-40USE-HTTP2-LIB-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FMINI-HTTP2:@USE-HTTP2-LIB%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FSYNCHRONOUS:@SYNCHRONOUS%20MGL-PAX:SECTION" title="Synchronous implementations">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FASYNC:@ASYNC%20MGL-PAX:SECTION" title="CL-ASYNC based implementation (asynchronous)">&#8594;</a> <a href="#TLS-SERVER%2FMINI-HTTP2:@USE-HTTP2-LIB%20MGL-PAX:SECTION" title="Server built using HTTP2 package.">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FMINI-HTTP2:@USE-HTTP2-LIB%20MGL-PAX:SECTION">7 Server built using HTTP2 package.</a></h2>
<h6>[in package TLS-SERVER/MINI-HTTP2]</h6>
<p>Server implementations so far used the simplified HTTP/2 protocol described
<a href="#TLS-SERVER%2FMINI-HTTP2:@HTTP2-PROTOCOL%20MGL-PAX:SECTION" title="HTTP/2 protocol.">above</a>. Now we do the same using
HTTP2, still synchronously to compare the ease of
implementation and speed.</p>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20T-20-28EQL-20-3ANONE-2FHTTP2-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%2FHTTP2%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20T%20%28EQL%20:NONE%2FHTTP2%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">LISTENING-SOCKET TLS (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:NONE/HTTP2</code>))</span></span></p>

<p>Handle the connection while doing nothing else using HTTP2 asdf library for actual work. Otherwise it is same as the <code>:NONE</code> method (i.e., serving a single client)</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-3A-40ASYNC-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FASYNC:@ASYNC%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FMINI-HTTP2:@USE-HTTP2-LIB%20MGL-PAX:SECTION" title="Server built using HTTP2 package.">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Asynchronous `TLS` server">&#8594;</a> <a href="#TLS-SERVER%2FASYNC:@ASYNC%20MGL-PAX:SECTION" title="CL-ASYNC based implementation (asynchronous)">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FASYNC:@ASYNC%20MGL-PAX:SECTION">8 CL-ASYNC based implementation (asynchronous)</a></h2>
<h6>[in package TLS-SERVER/ASYNC]</h6>
<p><a id="x-28TLS-SERVER-3ADO-NEW-CONNECTION-20-28METHOD-20NIL-20-28T-20-28EQL-20NIL-29-20-28EQL-20-3AASYNC-29-29-29-29"></a>
<a id="TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20NIL%29%20%28EQL%20:ASYNC%29%29%29"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[method]</span> <span class="reference-object"><a href="#TLS-SERVER:DO-NEW-CONNECTION%20%28METHOD%20NIL%20%28T%20%28EQL%20NIL%29%20%28EQL%20:ASYNC%29%29%29" >DO-NEW-CONNECTION</a></span></span> <span class="locative-args">SOCKET (TLS (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>NIL</code>)) (DISPATCH-METHOD (<code>EQL</code>(<a href="http://www.lispworks.com/documentation/HyperSpec/Body/f_eql.htm" title="EQL (MGL-PAX:CLHS FUNCTION)"><code>0</code></a> <a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_eql.htm" title="EQL (MGL-PAX:CLHS TYPE)"><code>1</code></a>) <code>:ASYNC</code>))</span></span></p>

<p>Handle new connections using cl-async event loop.</p>

<p>Pros: This version can be run in one thread and process many clients.</p>

<p>Cons: requires a specific C library, and the implementation as-is depends on
SBCL internal function - we re-use the file descriptor of socket created by
usocket package, as otherwise access to the port of server is complicated.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-3ARUN-UV-SERVER-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC:RUN-UV-SERVER%20FUNCTION"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC:RUN-UV-SERVER%20FUNCTION" >RUN-UV-SERVER</a></span></span> <span class="locative-args">&amp;KEY (PORT 2022)</span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3A-40ASYNC-SERVER-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FASYNC:@ASYNC%20MGL-PAX:SECTION" title="CL-ASYNC based implementation (asynchronous)">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@COMMUNICATION-SETUP%20MGL-PAX:SECTION" title="Communication setup">&#8594;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Asynchronous `TLS` server">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION">9 Asynchronous <code>TLS</code> server</a></h2>
<h6>[in package TLS-SERVER/ASYNC/TLS]</h6>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3ACLIENT-20CLASS-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:CLIENT%20CLASS"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[class]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:CLIENT%20CLASS" >CLIENT</a></span></span> <span class="locative-args"><a href="http://www.lispworks.com/documentation/HyperSpec/Body/t_stu_ob.htm" title="STRUCTURE-OBJECT (MGL-PAX:CLHS CLASS)">STRUCTURE-OBJECT</a></span></span></p>

<p>Data of one client connection. This includes:</p>

<ul>
<li><p>File desriptor (FD),</p></li>
<li><p><code>SSL</code> data opaque pointer (<code>SSL</code>),</p></li>
<li><p>Input and output <code>BIO</code> for exchanging data with <code>OPENSSL</code> (<code>RBIO</code>, <code>WBIO</code>),</p></li>
<li><p>Unencrypted octets to encrypt and send (<code>WRITE-BUF</code>),</p></li>
<li><p>Encrypted octets to send to the file descriptor (<code>ENCRYPT-BUF</code>),</p></li>
<li><p>Callback function when read data are available (<code>IO-ON-READ</code>).</p></li>
</ul></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3A-40COMMUNICATION-SETUP-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:@COMMUNICATION-SETUP%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Asynchronous `TLS` server">&#8592;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Asynchronous `TLS` server">&#8593;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Communication setup">&#8594;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@COMMUNICATION-SETUP%20MGL-PAX:SECTION" title="Communication setup">&#8634;</a></span></span></p>
<h3><a href="#TLS-SERVER%2FASYNC%2FTLS:@COMMUNICATION-SETUP%20MGL-PAX:SECTION">9.1 Communication setup</a></h3>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3AMAKE-SSL-CONTEXT-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:MAKE-SSL-CONTEXT%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:MAKE-SSL-CONTEXT%20FUNCTION" >MAKE-SSL-CONTEXT</a></span></span></span></p>

<p>Make a <code>SSL</code> context.</p>

<p>This includes public and private key pair (from files in this directory),</p>

<p>FUnctionally, it is same as <a href="#TLS-SERVER%2FMINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT%20FUNCTION" title="TLS-SERVER/MINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT FUNCTION"><code>TLS-SERVER/MINI-HTTP2:MAKE-HTTP2-TLS-CONTEXT</code></a>; however, it used directly cffi and sets some parameters in a different way.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3A-40REQUEST-HANDLING-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:@REQUEST-HANDLING%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FASYNC%2FTLS:@COMMUNICATION-SETUP%20MGL-PAX:SECTION" title="Communication setup">&#8592;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@ASYNC-SERVER%20MGL-PAX:SECTION" title="Asynchronous `TLS` server">&#8593;</a> <a href="#TLS-SERVER%2FUTILS:@MGL-EXTENSIONS%20MGL-PAX:SECTION" title="New locatives">&#8594;</a> <a href="#TLS-SERVER%2FASYNC%2FTLS:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Communication setup">&#8634;</a></span></span></p>
<h3><a href="#TLS-SERVER%2FASYNC%2FTLS:@REQUEST-HANDLING%20MGL-PAX:SECTION">9.2 Communication setup</a></h3>
<p>When <code>POLL</code> returns, each client is tested by <a href="#TLS-SERVER%2FASYNC%2FTLS:PROCESS-CLIENT-FD%20FUNCTION" title="TLS-SERVER/ASYNC/TLS:PROCESS-CLIENT-FD FUNCTION"><code>PROCESS-CLIENT-FD</code></a> whether read (or
write is possible). If so, DO-SOCK-READ is called to read the data, <a href="#TLS-SERVER%2FASYNC%2FTLS:DECRYPT-SOCKET-OCTETS%20FUNCTION" title="TLS-SERVER/ASYNC/TLS:DECRYPT-SOCKET-OCTETS FUNCTION"><code>DECRYPT-SOCKET-OCTETS</code></a> decrypts them, and calls a callback (slot <code>IO-ON-READ</code> of the client) to process them.</p>
<p>The application defined callback reads the data using <a href="#TLS-SERVER%2FASYNC%2FTLS:SSL-READ%20FUNCTION" title="TLS-SERVER/ASYNC/TLS:SSL-READ FUNCTION"><code>SSL-READ</code></a>, processes them, and sends response with <a href="#TLS-SERVER%2FASYNC%2FTLS:SEND-UNENCRYPTED-BYTES%20FUNCTION" title="TLS-SERVER/ASYNC/TLS:SEND-UNENCRYPTED-BYTES FUNCTION"><code>SEND-UNENCRYPTED-BYTES</code></a>.</p>
<p><code>SEND-UNENCRYPTED-BYTES</code> feeds data to a client buffer (slot <code>ENCRYPT-BUF</code>), and
later this data are processed by DO-ENCRYPT and after encryption are buffered in <code>WRITE-BUF</code> of the client. These data are sent to the client socket eventually by DO-SOCK-WRITE called from <code>PROCESS-CLIENT-FD</code> on the callback.</p>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3APROCESS-CLIENT-FD-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:PROCESS-CLIENT-FD%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:PROCESS-CLIENT-FD%20FUNCTION" >PROCESS-CLIENT-FD</a></span></span> <span class="locative-args">FD-PTR CLIENT</span></span></p>

<p>Process events available on <code>FD-PTR</code> with <code>CLIENT</code>.</p>

<p>Read if you can, write if you can, announce <code>DONE</code> when done.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3APROCESS-DATA-ON-SOCKET-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:PROCESS-DATA-ON-SOCKET%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:PROCESS-DATA-ON-SOCKET%20FUNCTION" >PROCESS-DATA-ON-SOCKET</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Read data from client socket. If something is read (and it should, as this is called when there should be a data), it is passed to the </p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3ADECRYPT-SOCKET-OCTETS-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:DECRYPT-SOCKET-OCTETS%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:DECRYPT-SOCKET-OCTETS%20FUNCTION" >DECRYPT-SOCKET-OCTETS</a></span></span> <span class="locative-args">CLIENT BUFFER SIZE</span></span></p>

<p>Process <code>SIZE</code> bytes received from the peer that are in the <code>BUFFER</code>.</p>

<p>Fed them into the <code>SSL</code> object to be unencrypted, and let the client callback
handle </p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3ASSL-READ-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:SSL-READ%20FUNCTION"></a></p>
<ul>
<li><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:SSL-READ%20FUNCTION" >SSL-READ</a></span></span> <span class="locative-args">SSL BUFFER BUFSIZE</span></span></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3ASEND-UNENCRYPTED-BYTES-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:SEND-UNENCRYPTED-BYTES%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:SEND-UNENCRYPTED-BYTES%20FUNCTION" >SEND-UNENCRYPTED-BYTES</a></span></span> <span class="locative-args">CLIENT NEW-DATA</span></span></p>

<p>Process new data to be encrypted and sent to client.</p>

<p>Data are just concatenated to the <code>ENCRYPT-BUF</code>. Someone later,
they would be encrypted and passed.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3AENCRYPT-DATA-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:ENCRYPT-DATA%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:ENCRYPT-DATA%20FUNCTION" >ENCRYPT-DATA</a></span></span> <span class="locative-args">CLIENT DATA</span></span></p>

<p>Encrypt data in client's <code>ENCRYPT-BUF</code>.</p>

<p>Do nothing if no data to encrypt or <code>SSL</code> not yet initialized.</p>

<p>Otherwise, use a temporary vector to write data </p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FASYNC-2FTLS-3AWRITE-DATA-TO-SOCKET-20FUNCTION-29"></a>
<a id="TLS-SERVER%2FASYNC%2FTLS:WRITE-DATA-TO-SOCKET%20FUNCTION"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[function]</span> <span class="reference-object"><a href="#TLS-SERVER%2FASYNC%2FTLS:WRITE-DATA-TO-SOCKET%20FUNCTION" >WRITE-DATA-TO-SOCKET</a></span></span> <span class="locative-args">CLIENT</span></span></p>

<p>Write buffered encrypted data to the client socket. Update the write buffer to
keep what did not fit.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FUTILS-3A-40MGL-EXTENSIONS-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER%2FUTILS:@MGL-EXTENSIONS%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FASYNC%2FTLS:@REQUEST-HANDLING%20MGL-PAX:SECTION" title="Communication setup">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER:@PACKAGES%20MGL-PAX:SECTION" title="Packages">&#8594;</a> <a href="#TLS-SERVER%2FUTILS:@MGL-EXTENSIONS%20MGL-PAX:SECTION" title="New locatives">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER%2FUTILS:@MGL-EXTENSIONS%20MGL-PAX:SECTION">10 New locatives</a></h2>
<h6>[in package TLS-SERVER/UTILS]</h6>
<p>Define a  locative to document CFFI callbacks.</p>
<p><a id="x-28TLS-SERVER-2FUTILS-3ADEFINE-DOCUMENTED-CALLBACK-20MGL-PAX-3AMACRO-29"></a>
<a id="TLS-SERVER%2FUTILS:DEFINE-DOCUMENTED-CALLBACK%20MGL-PAX:MACRO"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[macro]</span> <span class="reference-object"><a href="#TLS-SERVER%2FUTILS:DEFINE-DOCUMENTED-CALLBACK%20MGL-PAX:MACRO" >DEFINE-DOCUMENTED-CALLBACK</a></span></span> <span class="locative-args">NAME RES-TYPE ARGS DOCSTRING &amp;BODY BODY</span></span></p>

<p>Wrapper on <code>CFFI:DEFCALLBACK</code> that also tracks the args and docstrings.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-2FUTILS-3ACALLBACK-20MGL-PAX-3ALOCATIVE-29"></a>
<a id="TLS-SERVER%2FUTILS:CALLBACK%20MGL-PAX:LOCATIVE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[locative]</span> <span class="reference-object"><a href="#TLS-SERVER%2FUTILS:CALLBACK%20MGL-PAX:LOCATIVE" >CALLBACK</a></span></span></span></p>

<p>CFFI callback is a Lisp code that can be called from C.</p></li>
</ul>
<p><a id="x-28TLS-SERVER-3A-40PACKAGES-20MGL-PAX-3ASECTION-29"></a>
<a id="TLS-SERVER:@PACKAGES%20MGL-PAX:SECTION"></a></p>
<p><span class="outer-navigation"><span class="navigation"> <a href="#TLS-SERVER%2FUTILS:@MGL-EXTENSIONS%20MGL-PAX:SECTION" title="New locatives">&#8592;</a> <a href="index.html" title="Experiments with HTTP/2 server">&#8593;</a> <a href="#TLS-SERVER:@PACKAGES%20MGL-PAX:SECTION" title="Packages">&#8634;</a></span></span></p>
<h2><a href="#TLS-SERVER:@PACKAGES%20MGL-PAX:SECTION">11 Packages</a></h2>
<p><a id="x-28-22TLS-SERVER-22-20PACKAGE-29"></a>
<a id="%22TLS-SERVER%22%20PACKAGE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[package]</span> <span class="reference-object"><a href="#%22TLS-SERVER%22%20PACKAGE" >&quot;TLS-SERVER&quot;</a></span></span></span></p>

<p>Exports <a href="#TLS-SERVER:CREATE-SERVER%20FUNCTION" title="TLS-SERVER:CREATE-SERVER FUNCTION"><code>CREATE-SERVER</code></a> (needed to invoke a server),
<a href="#TLS-SERVER:DO-NEW-CONNECTION%20GENERIC-FUNCTION" title="TLS-SERVER:DO-NEW-CONNECTION GENERIC-FUNCTION"><code>DO-NEW-CONNECTION</code></a> (specialized to implement particular servers), and various
restarts. See <a href="#TLS-SERVER:@SERVER-ACTIONS%20MGL-PAX:SECTION" title="Generic server interface">Generic server interface</a>.</p>

<p>Also holds the top-level documentation sections, <a href="index.html" title="Experiments with HTTP/2 server">Experiments with HTTP/2 server</a> and <code>@OVERVIEW</code>.</p></li>
</ul>
<p><a id="x-28-22TLS-SERVER-2FUTILS-22-20PACKAGE-29"></a>
<a id="%22TLS-SERVER%2FUTILS%22%20PACKAGE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[package]</span> <span class="reference-object"><a href="#%22TLS-SERVER%2FUTILS%22%20PACKAGE" >&quot;TLS-SERVER/UTILS&quot;</a></span></span></span></p>

<p>Octet processing utilities. See <a href="#TLS-SERVER%2FUTILS:@OCTETS%20MGL-PAX:SECTION" title="Work with octets">Work with octets</a></p></li>
</ul>
<p><a id="x-28-22TLS-SERVER-2FMINI-HTTP2-22-20PACKAGE-29"></a>
<a id="%22TLS-SERVER%2FMINI-HTTP2%22%20PACKAGE"></a></p>
<ul>
<li><p><span class=reference-bullet><span class=reference><span class="locative-type">[package]</span> <span class="reference-object"><a href="#%22TLS-SERVER%2FMINI-HTTP2%22%20PACKAGE" >&quot;TLS-SERVER/MINI-HTTP2&quot;</a></span></span></span></p>

<p>Basic functionality for low-level HTTP2 implementation.</p></li>
</ul>
  </div>
</div>
<script>$('#page-toc').toc({'selectors': 'h1,h2,h3,h4'});</script>
</body>
</html>
